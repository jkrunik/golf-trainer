<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Golf Trainer</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0a3d2a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg:#062418;
      --bg2:#041a11;
      --card:#0a3d2a;
      --card2:#0b4a33;
      --text:#f1fff8;
      --muted:#bfe8d3;
      --line:rgba(255,255,255,.12);
      --gold:#f2c14e;
      --danger:#ff6b6b;
      --accent:#6ee7b7;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 0%, rgba(110,231,183,.20), transparent 55%),
        radial-gradient(900px 700px at 95% 10%, rgba(242,193,78,.15), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
    }
    .wrap{ max-width:820px; margin:0 auto; padding:18px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:14px;
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
    }
    h1{ font-size:22px; margin:0; letter-spacing:.3px; }
    .sub{ font-size:12px; color:var(--muted); opacity:.95; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background:rgba(255,255,255,.08); border:1px solid var(--line);
      font-size:12px; color:var(--muted);
      white-space:nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:50%; background:var(--gold); box-shadow:0 0 0 3px rgba(242,193,78,.18); }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 14px 40px rgba(0,0,0,.25);
      margin-bottom:14px;
      backdrop-filter: blur(6px);
    }
    .cardTitle{
      display:flex; align-items:baseline; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .cardTitle b{ font-size:18px; }
    .hint{ font-size:12px; color:var(--muted); }

    label{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }
    input[type="range"]{ width:100%; }
    select{
      width:100%; padding:10px;
      border-radius:12px; border:1px solid var(--line);
      background:rgba(0,0,0,.18); color:var(--text);
      outline:none;
    }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .row > *{ flex:1 1 auto; }
    .val{ font-variant-numeric: tabular-nums; font-weight:900; color:var(--gold); }
    button{
      border:0; border-radius:14px; padding:12px 14px;
      font-weight:900; cursor:pointer; width:100%;
    }
    .btn{
      background: linear-gradient(180deg, rgba(110,231,183,.95), rgba(110,231,183,.72));
      color:#042012;
      box-shadow: 0 10px 18px rgba(110,231,183,.18);
    }
    .btn.stop{
      background: linear-gradient(180deg, rgba(255,107,107,.95), rgba(255,107,107,.72));
      color:#2a0404;
      box-shadow: 0 10px 18px rgba(255,107,107,.18);
    }
    .divider{ height:1px; background:var(--line); margin:12px 0; }

    .shotBox{
      display:flex; flex-direction:column; gap:4px;
      padding:12px; border-radius:16px;
      border:1px dashed rgba(242,193,78,.35);
      background: rgba(0,0,0,.12);
    }
    .shotLabel{ font-size:12px; color:var(--muted); }
    .shotValue{ font-size:22px; font-weight:1000; letter-spacing:.2px; }

    .beats{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .beat{
      width:36px; height:36px; border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      font-weight:900; user-select:none;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--muted);
      cursor:pointer;
      transition: transform .06s ease;
    }
    .beat:active{ transform: scale(0.97); }
    .beat.accent{
      background: rgba(242,193,78,.22);
      border-color: rgba(242,193,78,.45);
      color: #fff2cc;
    }
    .beat.current{
      background: rgba(110,231,183,.35);
      border-color: rgba(110,231,183,.65);
      color: var(--text);
    }

    .tiny{ font-size:12px; color:var(--muted); line-height:1.35; }
    .footer{ margin-top:10px; font-size:12px; color:var(--muted); }
    a{ color: var(--accent); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>Golf Trainer</h1>
        <div class="sub">Shot Caller + 8/8 Metronome (offline, home-screen app)</div>
      </div>
      <div class="pill" id="offlinePill"><span class="dot"></span> Offline: …</div>
    </div>

    <div class="card">
      <div class="cardTitle">
        <b>One-time setup</b>
        <span class="hint">Required on iPhone Safari</span>
      </div>
      <div class="tiny">Tap this once so your iPhone allows speech + metronome audio.</div>
      <div class="divider"></div>
      <div class="row">
        <div style="flex:1 1 220px;">
          <button class="btn" id="unlockBtn">Tap to Enable Audio</button>
        </div>
        <div style="flex:2 1 300px;" class="tiny" id="unlockStatus">Not enabled yet.</div>
      </div>
    </div>

    <div class="card">
      <div class="cardTitle">
        <b>Shot Caller</b>
        <span class="hint">No repeats ✅</span>
      </div>

      <div class="row">
        <div style="flex:2 1 260px;">
          <label>Interval (seconds): <span class="val" id="shotIntervalVal">8</span></label>
          <input id="shotInterval" type="range" min="1" max="20" value="8" />
        </div>
        <div style="flex:1 1 200px;">
          <label>Voice</label>
          <select id="voiceSelect">
            <option value="">Default</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div style="flex:1 1 220px;">
          <button class="btn" id="shotBtn">Start Shot Caller</button>
        </div>
        <div style="flex:2 1 300px;">
          <div class="shotBox">
            <div class="shotLabel">Last call</div>
            <div class="shotValue" id="lastShot">—</div>
          </div>
        </div>
      </div>

      <div class="footer">Options: High/Mid/Low • Draw/Straight/Fade</div>
    </div>

    <div class="card">
      <div class="cardTitle">
        <b>Metronome (8/8)</b>
        <span class="hint">Tap beats to toggle accents</span>
      </div>

      <div class="row">
        <div style="flex:2 1 260px;">
          <label>Tempo (BPM): <span class="val" id="bpmVal">80</span></label>
          <input id="bpm" type="range" min="30" max="220" value="80" />
        </div>
        <div style="flex:1 1 200px;">
          <label>Click Volume: <span class="val" id="volVal">70%</span></label>
          <input id="vol" type="range" min="0" max="100" value="70" />
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div style="flex:1 1 220px;">
          <button class="btn" id="metroBtn">Start Metronome</button>
        </div>
        <div style="flex:2 1 300px;">
          <div class="tiny">Default accents: <b>1, 3, 4, 7</b> (customizable)</div>
          <div class="beats" id="beats"></div>
          <div class="row" style="margin-top:10px;">
            <div style="flex:1 1 160px;">
              <button class="btn" id="resetAccentsBtn" type="button">Reset to Default</button>
            </div>
          </div>
        </div>
      </div>

      <div class="footer">Tip: if clicks are quiet, turn off Silent Mode and raise volume.</div>
    </div>

    <div class="tiny">
      Install on iPhone: open in Safari → Share → <b>Add to Home Screen</b>.
    </div>
  </div>

<script>
/* ---------------------------
   Offline pill
---------------------------- */
const offlinePill = document.getElementById('offlinePill');
function updateOfflinePill() {
  offlinePill.lastChild.nodeValue = ` Offline: ${navigator.onLine ? 'No' : 'Yes'}`;
}
window.addEventListener('online', updateOfflinePill);
window.addEventListener('offline', updateOfflinePill);

/* ---------------------------
   PWA service worker
---------------------------- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  });
}

/* ---------------------------
   Audio unlock
---------------------------- */
let audioCtx = null;
let masterGain = null;
let audioEnabled = false;

const unlockBtn = document.getElementById('unlockBtn');
const unlockStatus = document.getElementById('unlockStatus');

function ensureAudioContext() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = 0.7;
    masterGain.connect(audioCtx.destination);
  }
}

async function unlockAudio() {
  try {
    ensureAudioContext();
    if (audioCtx.state !== 'running') await audioCtx.resume();

    // tiny inaudible tick (helps iOS accept audio)
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    g.gain.value = 0.0001;
    o.connect(g); g.connect(masterGain);
    o.start();
    o.stop(audioCtx.currentTime + 0.02);

    populateVoices();

    audioEnabled = true;
    unlockStatus.textContent = 'Audio enabled ✅ (speech + clicks should work).';
    unlockBtn.textContent = 'Audio Enabled';
    unlockBtn.disabled = true;
    unlockBtn.style.opacity = '0.75';
  } catch {
    unlockStatus.textContent = 'Could not enable audio. Try tapping again with ringer on.';
  }
}
unlockBtn.addEventListener('click', unlockAudio);

/* ---------------------------
   Speech (Shot Caller) — NO REPEATS
---------------------------- */
const shots = [
  'High draw','High straight','High fade',
  'Mid draw','Mid straight','Mid fade',
  'Low draw','Low straight','Low fade'
];

const shotInterval = document.getElementById('shotInterval');
const shotIntervalVal = document.getElementById('shotIntervalVal');
const shotBtn = document.getElementById('shotBtn');
const lastShotEl = document.getElementById('lastShot');
const voiceSelect = document.getElementById('voiceSelect');

shotInterval.addEventListener('input', () => {
  shotIntervalVal.textContent = shotInterval.value;
  if (shotRunning) restartShotCaller();
});

let shotTimer = null;
let shotRunning = false;
let lastShot = null;

function pickRandomShotNoRepeat() {
  if (shots.length <= 1) return shots[0];
  let pick = shots[Math.floor(Math.random() * shots.length)];
  // reroll until different (safe because length is 9)
  while (pick === lastShot) {
    pick = shots[Math.floor(Math.random() * shots.length)];
  }
  return pick;
}

function speak(text) {
  if (!audioEnabled) {
    unlockStatus.textContent = 'Tap "Enable Audio" first (required on iPhone).';
    return;
  }
  if (!('speechSynthesis' in window)) return;

  window.speechSynthesis.cancel();

  const utter = new SpeechSynthesisUtterance(text);
  utter.rate = 0.95;
  utter.pitch = 1.0;
  utter.volume = 1.0;

  const selectedVoiceURI = voiceSelect.value;
  if (selectedVoiceURI) {
    const v = speechSynthesis.getVoices().find(x => x.voiceURI === selectedVoiceURI);
    if (v) utter.voice = v;
  }
  window.speechSynthesis.speak(utter);
}

function tickShot() {
  const s = pickRandomShotNoRepeat();
  lastShot = s;
  lastShotEl.textContent = s;
  speak(s);
}

function startShotCaller() {
  shotRunning = true;
  shotBtn.textContent = 'Stop Shot Caller';
  shotBtn.classList.add('stop');

  tickShot(); // speak immediately on start
  clearInterval(shotTimer);
  shotTimer = setInterval(tickShot, Number(shotInterval.value) * 1000);
}

function stopShotCaller() {
  shotRunning = false;
  shotBtn.textContent = 'Start Shot Caller';
  shotBtn.classList.remove('stop');
  clearInterval(shotTimer);
  shotTimer = null;
}

function restartShotCaller() {
  if (!shotRunning) return;
  startShotCaller();
}

shotBtn.addEventListener('click', () => {
  if (shotRunning) stopShotCaller();
  else startShotCaller();
});

/* Voices */
function populateVoices() {
  if (!('speechSynthesis' in window)) return;
  const voices = speechSynthesis.getVoices();
  const current = voiceSelect.value;

  const defaultOpt = document.createElement('option');
  defaultOpt.value = '';
  defaultOpt.textContent = 'Default';

  voiceSelect.innerHTML = '';
  voiceSelect.appendChild(defaultOpt);

  const sorted = [...voices].sort((a,b) => {
    const ae = a.lang?.toLowerCase().startsWith('en') ? 0 : 1;
    const be = b.lang?.toLowerCase().startsWith('en') ? 0 : 1;
    if (ae !== be) return ae - be;
    return (a.name || '').localeCompare(b.name || '');
  });

  for (const v of sorted) {
    const opt = document.createElement('option');
    opt.value = v.voiceURI;
    opt.textContent = `${v.name} (${v.lang})`;
    voiceSelect.appendChild(opt);
  }
  if (current) voiceSelect.value = current;
}
if ('speechSynthesis' in window) {
  speechSynthesis.onvoiceschanged = populateVoices;
}

/* ---------------------------
   Metronome (8/8) — CUSTOM ACCENTS
---------------------------- */
const bpm = document.getElementById('bpm');
const bpmVal = document.getElementById('bpmVal');
const vol = document.getElementById('vol');
const volVal = document.getElementById('volVal');
const metroBtn = document.getElementById('metroBtn');
const beatsEl = document.getElementById('beats');
const resetAccentsBtn = document.getElementById('resetAccentsBtn');

// Default accents: beats 1,3,4,7 => indices 0,2,3,6
const defaultAccentIndices = [0,2,3,6];
let accentSet = new Set(defaultAccentIndices);

let metroRunning = false;
let beatIndex = 0;
let metroIntervalId = null;

function renderBeats() {
  beatsEl.innerHTML = '';
  for (let i=0;i<8;i++) {
    const d = document.createElement('div');
    d.className = 'beat' +
      (accentSet.has(i) ? ' accent' : '') +
      (metroRunning && i === beatIndex ? ' current' : '');
    d.textContent = String(i+1);

    d.addEventListener('click', () => {
      // toggle accent
      if (accentSet.has(i)) accentSet.delete(i);
      else accentSet.add(i);
      renderBeats();
    });

    beatsEl.appendChild(d);
  }
}

resetAccentsBtn.addEventListener('click', () => {
  accentSet = new Set(defaultAccentIndices);
  renderBeats();
});

function setVolumeUI() {
  volVal.textContent = `${vol.value}%`;
  if (masterGain) masterGain.gain.value = Number(vol.value) / 100;
}
vol.addEventListener('input', setVolumeUI);

bpm.addEventListener('input', () => {
  bpmVal.textContent = bpm.value;
  if (metroRunning) restartMetronome();
});

function click(accent) {
  if (!audioEnabled) {
    unlockStatus.textContent = 'Tap "Enable Audio" first (required on iPhone).';
    return;
  }
  ensureAudioContext();

  const now = audioCtx.currentTime;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();

  o.frequency.value = accent ? 1300 : 900;

  const peak = accent ? 1.0 : 0.55;
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(peak, now + 0.005);
  g.gain.exponentialRampToValueAtTime(0.0001, now + (accent ? 0.05 : 0.035));

  o.connect(g);
  g.connect(masterGain);

  o.start(now);
  o.stop(now + 0.06);
}

function metroTick() {
  const isAccent = accentSet.has(beatIndex);

  // Only play sound on active (accented) beats
  if (isAccent) {
    click(true); // always use the "accent" click sound
  }

  renderBeats();
  beatIndex = (beatIndex + 1) % 8;
}

function startMetronome() {
  metroRunning = true;
  metroBtn.textContent = 'Stop Metronome';
  metroBtn.classList.add('stop');
  beatIndex = 0;
  setVolumeUI();

  metroTick(); // immediate
  const intervalMs = 60000 / Number(bpm.value);
  clearInterval(metroIntervalId);
  metroIntervalId = setInterval(metroTick, intervalMs);
}

function stopMetronome() {
  metroRunning = false;
  metroBtn.textContent = 'Start Metronome';
  metroBtn.classList.remove('stop');
  clearInterval(metroIntervalId);
  metroIntervalId = null;
  beatIndex = 0;
  renderBeats();
}

function restartMetronome() {
  if (!metroRunning) return;
  startMetronome();
}

metroBtn.addEventListener('click', () => {
  if (metroRunning) stopMetronome();
  else startMetronome();
});

/* ---------------------------
   Init UI values
---------------------------- */
shotIntervalVal.textContent = shotInterval.value;
bpmVal.textContent = bpm.value;
renderBeats();
updateOfflinePill();

/* Best-effort screen wake lock (not always supported in iOS PWA) */
let wakeLock = null;
async function tryWakeLock() {
  try {
    if ('wakeLock' in navigator && metroRunning) {
      wakeLock = await navigator.wakeLock.request('screen');
    }
  } catch {}
}
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') tryWakeLock();
});
</script>
</body>
</html>